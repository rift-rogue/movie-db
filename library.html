<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Library</title>
<style>
body { margin:0; font-family:system-ui; background:#f7f7f7 }
header { padding:12px; background:#111; color:white }
input {
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ccc;
}
.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:12px;
  padding:12px;
}
.card { background:white; border-radius:8px; padding:8px }
.card img { width:100%; border-radius:6px; aspect-ratio:2/3; object-fit:cover; background:#eee }
.card-title { font-size:12px; margin:6px 0 2px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
.card-year { font-size:11px; color:#666; margin-bottom:6px }
.actions { display:flex; gap:4px }
.actions a, .actions button {
  flex:1;
  padding:3px 4px;
  font-size:9px;
  border:1px solid #ddd;
  border-radius:4px;
  background:white;
  color:#555;
  text-decoration:none;
  text-align:center;
  cursor:pointer;
}
.actions a:hover, .actions button:hover { background:#f5f5f5 }
.nav { display:flex; justify-content:space-between; padding:12px }
.nav button { padding:8px 16px; border:1px solid #ddd; background:white; border-radius:6px; cursor:pointer }
.nav button:disabled { opacity:0.5; cursor:not-allowed }
</style>
</head>
<body>

<header>
<input id="q" placeholder="Search library">
</header>

<div class="grid" id="grid"></div>

<div class="nav">
<button id="prev" onclick="page>1&&(page--,load())">Prev</button>
<button id="next" onclick="next.disabled||(page++,load())">Next</button>
</div>

<script>
let page=1

async function load(){
  let r = await fetch(`/search/local?q=${encodeURIComponent(q.value)}&page=${page}`)
  let d = await r.json()
  grid.innerHTML=""
  
  prev.disabled = page<=1
  next.disabled = !d || d.length<20
  
  if(!d || d.length===0){
    grid.innerHTML="<div style='text-align:center;padding:40px;color:#999'>No results</div>"
    return
  }
  d.forEach(x=>{
    let poster = x[3] ? `https://image.tmdb.org/t/p/w154${x[3]}` : ""
    let imdb = x[4] ? `<a href="https://www.imdb.com/title/${x[4]}" target="_blank">IMDb</a>` : ""
    let tmdb = x[6] ? `<a href="https://www.themoviedb.org/${x[5]}/${x[6]}" target="_blank">TMDb</a>` : ""
    grid.innerHTML+=`
      <div class="card">
        <img src="${poster}">
        <div class="card-title">${x[1]}</div>
        <div class="card-year">${x[2]||""}</div>
        <div class="actions">
          ${imdb}
          ${tmdb}
          <button onclick="del(${x[0]})">Delete</button>
        </div>
      </div>`
  })
}

async function del(id){
  if(!confirm('Delete this?')) return
  await fetch(`/delete/${id}`,{method:'DELETE'})
  load()
}

let timer
q.oninput=()=>{
  clearTimeout(timer)
  timer=setTimeout(()=>{page=1;load()},300)
}
load()
</script>

</body>
</html>
